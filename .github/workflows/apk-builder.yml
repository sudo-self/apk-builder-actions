name: APK Builder

on:
  repository_dispatch:
    types: [apk_build]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Clone and customize
      run: |
        git clone https://github.com/sudo-self/template_apk.git android-project
        cd android-project
        
        # Find and update the JSON config file (twa-manifest.json)
        JSON_FILE=$(find . -name "twa-manifest.json" -type f | head -1)
        if [ -z "$JSON_FILE" ]; then
          JSON_FILE=$(find . -name "*.json" -type f | grep -v "build" | grep -v "package" | head -1)
        fi
        echo "Found JSON config at: $JSON_FILE"
        
        # Set icon URL based on choice
        if [ "$ICON_CHOICE" = "castle" ]; then
          ICON_URL="https://apk.jessejesse.com/castle-512.png"
        elif [ "$ICON_CHOICE" = "smile" ]; then
          ICON_URL="https://apk.jessejesse.com/smile-512.png"
        else
          ICON_URL="https://apk.jessejesse.com/phone-512.png"
        fi
        
        # Backup original manifest
        cp "$JSON_FILE" "$JSON_FILE.original"
        
        # Update the JSON file with all custom values
        sed -i "s|\"host\": \"[^\"]*\"|\"host\": \"$HOST_NAME\"|g" "$JSON_FILE"
        sed -i "s|\"name\": \"[^\"]*\"|\"name\": \"$APP_NAME\"|g" "$JSON_FILE"
        sed -i "s|\"launcherName\": \"[^\"]*\"|\"launcherName\": \"$LAUNCHER_NAME\"|g" "$JSON_FILE"
        sed -i "s|\"startUrl\": \"[^\"]*\"|\"startUrl\": \"$LAUNCH_URL\"|g" "$JSON_FILE"
        sed -i "s|\"themeColor\": \"[^\"]*\"|\"themeColor\": \"$THEME_COLOR\"|g" "$JSON_FILE"
        sed -i "s|\"themeColorDark\": \"[^\"]*\"|\"themeColorDark\": \"$THEME_COLOR_DARK\"|g" "$JSON_FILE"
        sed -i "s|\"backgroundColor\": \"[^\"]*\"|\"backgroundColor\": \"$BACKGROUND_COLOR\"|g" "$JSON_FILE"
        sed -i "s|\"fullScopeUrl\": \"[^\"]*\"|\"fullScopeUrl\": \"https://$HOST_NAME/\"|g" "$JSON_FILE"
        sed -i "s|\"iconUrl\": \"[^\"]*\"|\"iconUrl\": \"$ICON_URL\"|g" "$JSON_FILE"
        
        # Calculate new checksum for the modified manifest
        NEW_CHECKSUM=$(sha1sum "$JSON_FILE" | cut -d' ' -f1)
        echo "New manifest checksum: $NEW_CHECKSUM"
        
        # Update manifest-checksum.txt with the new checksum
        MANIFEST_CHECKSUM_FILE=$(find . -name "manifest-checksum.txt" -type f | head -1)
        if [ -n "$MANIFEST_CHECKSUM_FILE" ]; then
          echo "Updating manifest-checksum.txt at: $MANIFEST_CHECKSUM_FILE"
          echo "$NEW_CHECKSUM" > "$MANIFEST_CHECKSUM_FILE"
          echo "Updated manifest-checksum.txt with: $NEW_CHECKSUM"
        else
          echo "WARNING: manifest-checksum.txt not found!"
        fi
        
        # Also update strings.xml as backup
        sed -i "s|<string name=\"hostName\">[^<]*</string>|<string name=\"hostName\">$HOST_NAME</string>|g" app/src/main/res/values/strings.xml
        sed -i "s|<string name=\"launchUrl\">[^<]*</string>|<string name=\"launchUrl\">https://$HOST_NAME$LAUNCH_URL</string>|g" app/src/main/res/values/strings.xml
        sed -i "s|<string name=\"appName\">[^<]*</string>|<string name=\"appName\">$APP_NAME</string>|g" app/src/main/res/values/strings.xml
        sed -i "s|<string name=\"launcherName\">[^<]*</string>|<string name=\"launcherName\">$LAUNCHER_NAME</string>|g" app/src/main/res/values/strings.xml
        
        echo "Updated JSON config:"
        cat "$JSON_FILE" | grep -E "(host|name|launcherName|startUrl|themeColor|iconUrl)"
        echo "Using icon: $ICON_URL"
        
        # Verify checksum was updated
        if [ -n "$MANIFEST_CHECKSUM_FILE" ]; then
          echo "Current manifest-checksum.txt content:"
          cat "$MANIFEST_CHECKSUM_FILE"
        fi
      env:
        HOST_NAME: ${{ github.event.client_payload.hostName }}
        LAUNCH_URL: ${{ github.event.client_payload.launchUrl }}
        APP_NAME: ${{ github.event.client_payload.name }}
        LAUNCHER_NAME: ${{ github.event.client_payload.launcherName }}
        THEME_COLOR: ${{ github.event.client_payload.themeColor }}
        THEME_COLOR_DARK: ${{ github.event.client_payload.themeColorDark }}
        BACKGROUND_COLOR: ${{ github.event.client_payload.backgroundColor }}
        ICON_CHOICE: ${{ github.event.client_payload.iconChoice }}

    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.client_payload.name }}-app
        path: android-project/app/build/outputs/apk/debug/app-debug.apk




