name: APK Builder

on:
  repository_dispatch:
    types: [apk_build]
  workflow_dispatch:
    inputs:
      buildId:
        description: 'Build ID'
        required: true
        default: 'test-build-123'
      hostName:
        description: 'Host name'
        required: true
        default: 'example.com'
      name:
        description: 'App name'
        required: true
        default: 'Test App'
      launcherName:
        description: 'Launcher name'
        required: false
        default: 'Test App'
      themeColor:
        description: 'Theme color'
        required: false
        default: '#171717'
      themeColorDark:
        description: 'Theme color dark'
        required: false
        default: '#000000'
      backgroundColor:
        description: 'Background color'
        required: false
        default: '#FFFFFF'

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout APK Builder repo
      uses: actions/checkout@v4

    - name: Checkout Template APK repo
      uses: actions/checkout@v4
      with:
        repository: sudo-self/template_apk
        token: ${{ secrets.GITHUB_TOKEN }}
        path: android-project

    - name: Copy Signing Key
      run: cp android-project/android.keystore android-project/android.keystore

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: "temurin"
        java-version: "17"

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Customize Android Project
      env:
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        HOST_NAME: ${{ github.event.client_payload.hostName || github.event.inputs.hostName }}
        LAUNCH_URL: "/"
        APP_NAME: ${{ github.event.client_payload.name || github.event.inputs.name }}
        LAUNCHER_NAME: ${{ github.event.client_payload.launcherName || github.event.inputs.launcherName }}
        THEME_COLOR: ${{ github.event.client_payload.themeColor || github.event.inputs.themeColor }}
        THEME_COLOR_DARK: ${{ github.event.client_payload.themeColorDark || github.event.inputs.themeColorDark }}
        BACKGROUND_COLOR: ${{ github.event.client_payload.backgroundColor || github.event.inputs.backgroundColor }}
      run: |
        cd android-project
        cp ../scripts/customize-project.py .
        python3 customize-project.py

    # ✅ BUILD EXACTLY ONE UNSIGNED APK
    - name: Build Release APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew clean assembleRelease --no-daemon --stacktrace

        echo "=== Removing junk APKs ==="
        # Delete ALL extra APKs the template creates except *release-unsigned.apk
        find app/build/outputs/apk/release -type f ! -name "app-release-unsigned.apk" -delete

        echo "Remaining files:"
        ls -l app/build/outputs/apk/release

    # ✅ SIGN + ZIPALIGN GUARANTEED ONE FINAL APK
    - name: Sign and Align APK
      run: |
        cd android-project

        APK="$(find app/build/outputs/apk/release -name app-release-unsigned.apk | head -1)"
        echo "Using unsigned APK: $APK"

        APKSIGNER=$(find "$ANDROID_HOME" -name apksigner | head -1)
        ZIPALIGN=$(find "$ANDROID_HOME" -name zipalign | head -1)

        SIGNED="signed.apk"
        FINAL="final.apk"

        echo "=== Signing ==="
        "$APKSIGNER" sign \
          --ks android.keystore \
          --ks-pass pass:123321 \
          --ks-key-alias android \
          --key-pass pass:123321 \
          --out "$SIGNED" \
          "$APK"

        echo "=== Verifying signature ==="
        "$APKSIGNER" verify "$SIGNED"

        echo "=== Zipalign ==="
        "$ZIPALIGN" -v -p 4 "$SIGNED" "$FINAL"

        CLEAN_NAME=$(echo "${{ github.event.client_payload.name || github.event.inputs.name }}" | tr ' ' '-' | tr -cd '[:alnum:]-._')
        mv "$FINAL" "../${CLEAN_NAME}.apk"

        echo "✅ FINAL APK: ../${CLEAN_NAME}.apk"

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Built-APK
        path: ${{ github.event.client_payload.name || github.event.inputs.name }}.apk
        retention-days: 7


    - name: Notify Success via Webhook
      if: success() && env.WEBHOOK_URL
      run: |
        python scripts/notify-webhook.py success
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        ARTIFACT_NAME: ${{ github.event.client_payload.name || github.event.inputs.name }}-APK

    - name: Notify Failure via Webhook
      if: failure() && env.WEBHOOK_URL
      run: |
        python scripts/notify-webhook.py failure
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}




