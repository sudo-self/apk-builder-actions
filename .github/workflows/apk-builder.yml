- name: Install Bubblewrap
  run: npm install -g @bubblewrap/cli

- name: Clone Android template
  run: git clone https://github.com/sudo-self/template_apk.git android-project

- name: Decode keystore
  run: |
    echo $KEYSTORE_BASE64 | base64 --decode > android-project/my-release-key.jks
  env:
    KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

- name: Customize and build APK (non-interactive)
  run: |
    cd android-project
    npx bubblewrap init \
      --manifest=$LAUNCH_URL/manifest.json \
      --packageId=com.example.${APP_NAME,,} \
      --name="$APP_NAME" \
      --applicationName="$APP_NAME" \
      --non-interactive

    npx bubblewrap update \
      --keystore=my-release-key.jks \
      --keystorePassword=$KEYSTORE_PASSWORD \
      --keyAlias=$KEY_ALIAS \
      --keyPassword=$KEY_PASSWORD \
      --non-interactive

    npx bubblewrap build

    # Rename APK to match app name
    mv ./app/build/outputs/apk/release/app-release.apk ../${APP_NAME}.apk
  env:
    LAUNCH_URL: ${{ github.event.client_payload.launchUrl }}
    APP_NAME: ${{ github.event.client_payload.name }}
    KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
    KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
    KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

- name: Upload APK
  uses: actions/upload-artifact@v4
  with:
    name: ${{ github.event.client_payload.name }}-app
    path: ./${{ github.event.client_payload.name }}.apk













