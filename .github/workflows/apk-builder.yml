- name: Build Release APK
  run: |
    cd android-project
    chmod +x gradlew
    
    # Verify keystore exists
    echo "=== Checking for keystore ==="
    if [ -f "android.keystore" ]; then
      echo "✅ Keystore found"
      ls -la android.keystore
    else
      echo "❌ Keystore not found!"
      find . -name "*.keystore" -type f
      exit 1
    fi
    
    # Build with more info
    ./gradlew clean assembleRelease --no-daemon --stacktrace --info

    # Check all APKs that were built
    echo "=== All generated APKs ==="
    find app/build/outputs -name "*.apk" -type f | while read apk; do
      echo "APK: $apk"
      ls -la "$apk"
      echo "Size: $(du -h "$apk" | cut -f1)"
      echo "---"
    done

- name: Sign and Align APK
  run: |
    cd android-project
    
    # List available APKs
    echo "=== Available APKs before signing ==="
    find app/build/outputs -name "*.apk" -type f
    
    # Use the correct APK path
    APK_PATH="app/build/outputs/apk/release/app-release-unsigned.apk"
    
    if [ ! -f "$APK_PATH" ]; then
      echo "❌ Release APK not found at expected path: $APK_PATH"
      echo "Trying to find any release APK..."
      APK_PATH=$(find app/build/outputs -name "*release*.apk" -type f | head -1)
      if [ -z "$APK_PATH" ]; then
        echo "❌ No release APK found at all!"
        exit 1
      fi
      echo "Using alternative APK: $APK_PATH"
    fi
    
    # Verify APK structure
    echo "=== Analyzing APK structure ==="
    file "$APK_PATH"
    unzip -l "$APK_PATH" | head -20
    
    # Find Android tools
    APKSIGNER=$(find "$ANDROID_HOME" -name apksigner -type f | head -1)
    ZIPALIGN=$(find "$ANDROID_HOME" -name zipalign -type f | head -1)
    
    echo "APK Signer: $APKSIGNER"
    echo "Zipalign: $ZIPALIGN"
    
    # Sign APK
    echo "=== Signing APK ==="
    "$APKSIGNER" sign \
      --ks android.keystore \
      --ks-pass pass:123321 \
      --ks-key-alias android \
      --key-pass pass:123321 \
      --out signed.apk "$APK_PATH"
    
    echo "=== Verifying signature ==="
    "$APKSIGNER" verify --verbose signed.apk
    
    echo "=== Zipaligning ==="
    "$ZIPALIGN" -v -p 4 signed.apk final.apk
    
    echo "=== Final APK check ==="
    ls -la final.apk
    file final.apk
    
    # Basic APK validation
    echo "=== Validating APK structure ==="
    if unzip -l final.apk | grep -q "AndroidManifest.xml"; then
      echo "✅ AndroidManifest.xml found in APK"
    else
      echo "❌ AndroidManifest.xml missing from APK"
    fi
    
    if unzip -l final.apk | grep -q "classes.dex"; then
      echo "✅ classes.dex found in APK"
    else
      echo "❌ classes.dex missing from APK"
    fi
    
    if unzip -l final.apk | grep -q "resources.arsc"; then
      echo "✅ resources.arsc found in APK"
    else
      echo "❌ resources.arsc missing from APK"
    fi

- name: Upload APK Artifact
  uses: actions/upload-artifact@v4
  with:
    name: Built-APK
    path: android-project/final.apk
    retention-days: 7

    - name: Notify Success via Webhook
      if: success() && env.WEBHOOK_URL
      run: python scripts/notify-webhook.py success
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        ARTIFACT_NAME: ${{ github.event.client_payload.name || github.event.inputs.name }}-APK

    - name: Notify Failure via Webhook
      if: failure() && env.WEBHOOK_URL
      run: python scripts/notify-webhook.py failure
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}





