name: APK Builder

on:
  repository_dispatch:
    types: [apk_build]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Clone template
      run: |
        git clone https://github.com/sudo-self/template_apk.git android-project

    - name: Simple customization - Update URL and name
      run: |
        cd android-project
        
        # Update the URL in MainActivity.java
        sed -i "s|https://example.com|$HOST_NAME|g" app/src/main/java/com/example/webviewapp/MainActivity.java
        sed -i "s|example.com|$HOST_NAME|g" app/src/main/java/com/example/webviewapp/MainActivity.java
        
        # Update app name in strings.xml
        sed -i "s|<string name=\"app_name\">.*</string>|<string name=\"app_name\">$APP_NAME</string>|g" app/src/main/res/values/strings.xml
        sed -i "s|<string name=\"launcher_name\">.*</string>|<string name=\"launcher_name\">$LAUNCHER_NAME</string>|g" app/src/main/res/values/strings.xml
        
        echo "Updated URL to: $HOST_NAME"
        echo "Updated app name to: $APP_NAME"
      env:
        HOST_NAME: ${{ github.event.client_payload.hostName }}
        APP_NAME: ${{ github.event.client_payload.name }}
        LAUNCHER_NAME: ${{ github.event.client_payload.launcherName }}

    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Sign APK
      run: |
        cd android-project
        zipalign -p 4 app/build/outputs/apk/debug/app-debug.apk app/build/outputs/apk/debug/app-signed.apk
        apksigner sign --ks android.keystore --ks-pass pass:123321 --key-pass pass:123321 --ks-key-alias android app/build/outputs/apk/debug/app-signed.apk

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.client_payload.name }}-app
        path: android-project/app/build/outputs/apk/debug/app-signed.apk




