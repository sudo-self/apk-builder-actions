name: APK Builder

on:
  repository_dispatch:
    types: [apk_build]
  workflow_dispatch:
    inputs:
      buildId:
        description: 'Build ID'
        required: true
        default: 'test-build-123'
      hostName:
        description: 'Host name'
        required: true
        default: 'example.com'
      name:
        description: 'App name'
        required: true
        default: 'Test App'
      launcherName:
        description: 'Launcher name'
        required: false
        default: 'Test App'
      themeColor:
        description: 'Theme color'
        required: false
        default: '#FFFFFF'
      backgroundColor:
        description: 'Background color'
        required: false
        default: '#FFFFFF'

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout APK Builder repo
      uses: actions/checkout@v4
      
    - name: Checkout Template APK repo
      uses: actions/checkout@v4
      with:
        repository: sudo-self/template_apk
        token: ${{ secrets.GITHUB_TOKEN }}
        path: android-project
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Customize Android Project
      run: |
        python scripts/customize-project.py
      
    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleRelease --no-daemon --stacktrace
        
    - name: Find Built APK
      id: find-apk
      run: |
        cd android-project
        
        # Use direct path to the APK
        APK_PATH="app/build/outputs/apk/release/app-release-unsigned.apk"
        
        if [ ! -f "$APK_PATH" ]; then
          echo "âŒ APK not found at expected path: $APK_PATH"
          echo "ðŸ” Searching for APK files..."
          find . -name "*.apk" -type f
          exit 1
        fi
        
        echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Found APK: $APK_PATH"
        
        # Get file size
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        echo "APK_SIZE=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "ðŸ“Š APK Size: $APK_SIZE"
        
    - name: Sign APK with android.keystore
      id: sign-apk
      run: |
        cd android-project
        
        # Verify keystore exists
        if [ ! -f "android.keystore" ]; then
          echo "âŒ android.keystore not found in project root"
          ls -la
          exit 1
        fi
        
        echo "ðŸ” Found android.keystore, signing APK..."
        
        # Set up Android SDK paths
        export ANDROID_HOME="${{ env.ANDROID_HOME }}"
        export ANDROID_SDK_ROOT="${{ env.ANDROID_SDK_ROOT }}"
        
        # Find apksigner
        APKSIGNER_PATH=$(find "$ANDROID_HOME/build-tools" -name "apksigner" | head -1)
        if [ -z "$APKSIGNER_PATH" ]; then
          echo "âŒ apksigner not found in Android SDK"
          exit 1
        fi
        
        echo "ðŸ“„ Using apksigner: $APKSIGNER_PATH"
        
        # Sign the APK
        UNSIGNED_APK="${{ steps.find-apk.outputs.APK_PATH }}"
        SIGNED_APK="${UNSIGNED_APK%.apk}-signed.apk"
        
        echo "ðŸ” Signing: $UNSIGNED_APK"
        echo "ðŸ’¾ Output: $SIGNED_APK"
        
        # Sign with apksigner - ignore warnings
        "$APKSIGNER_PATH" sign \
          --ks android.keystore \
          --ks-pass pass:123321 \
          --key-pass pass:123321 \
          --ks-key-alias android \
          --out "$SIGNED_APK" \
          "$UNSIGNED_APK" || echo "âš ï¸ Signing completed with warnings"
        
        echo "SIGNED_APK_PATH=$SIGNED_APK" >> $GITHUB_OUTPUT
        echo "âœ… APK signed successfully"
        
    - name: Verify Signed APK Exists
      id: verify-apk
      run: |
        cd android-project
        
        SIGNED_APK="${{ steps.sign-apk.outputs.SIGNED_APK_PATH }}"
        echo "ðŸ” Checking signed APK: $SIGNED_APK"
        
        if [ ! -f "$SIGNED_APK" ]; then
          echo "âŒ Signed APK not found at: $SIGNED_APK"
          echo "ðŸ“ Available files in directory:"
          ls -la "$(dirname "$SIGNED_APK")" 2>/dev/null || echo "Directory not found"
          echo "ðŸ” All APK files:"
          find . -name "*.apk" -type f -exec ls -la {} \;
          exit 1
        fi
        
        SIGNED_SIZE=$(du -h "$SIGNED_APK" | cut -f1)
        echo "SIGNED_SIZE=$SIGNED_SIZE" >> $GITHUB_OUTPUT
        echo "ðŸ“Š Signed APK Size: $SIGNED_SIZE"
        echo "âœ… Signed APK verified"
        
    - name: Upload Signed APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        path: android-project/${{ steps.sign-apk.outputs.SIGNED_APK_PATH }}
        retention-days: 7
        
    - name: Create Build Summary
      run: |
        echo "ðŸŽ‰ APK Build Completed Successfully!"
        echo "### ðŸ“± APK Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”§ App: ${{ github.event.client_payload.name || github.event.inputs.name }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ Domain: ${{ github.event.client_payload.hostName || github.event.inputs.hostName }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ APK File: ${{ steps.sign-apk.outputs.SIGNED_APK_PATH }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š Size: ${{ steps.find-apk.outputs.APK_SIZE }} (unsigned) â†’ ${{ steps.verify-apk.outputs.SIGNED_SIZE }} (signed)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Download:**" >> $GITHUB_STEP_SUMMARY
        echo "The signed APK is available in the artifacts below." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> âš ï¸ Note: The signature warnings are normal and don't affect APK functionality." >> $GITHUB_STEP_SUMMARY
        echo "> âš ï¸ Note: The signature warnings are normal and don't affect APK functionality." >> $GITHUB_STEP_SUMMARY
        
    - name: Notify Success via Webhook
      if: success() && env.WEBHOOK_URL
      run: |
        python scripts/notify-webhook.py success
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        ARTIFACT_NAME: apk-${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        
    - name: Notify Failure via Webhook
      if: failure() && env.WEBHOOK_URL
      run: |
        python scripts/notify-webhook.py failure
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
