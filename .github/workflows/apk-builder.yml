name: APK Builder

on:
  repository_dispatch:
    types: [apk_build]
  workflow_dispatch:
    inputs:
      buildId:
        description: 'Build ID'
        required: true
      hostName:
        description: 'Host name'
        required: true
      name:
        description: 'App name'
        required: true

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout APK Builder repo
      uses: actions/checkout@v4
      
    - name: Checkout Template APK repo
      uses: actions/checkout@v4
      with:
        repository: sudo-self/template_apk
        token: ${{ secrets.GITHUB_TOKEN }}
        path: android-project
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Customize Android Project
      run: |
        python scripts/customize-project.py
      
    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleRelease --no-daemon --stacktrace
        
    - name: Find APK
      id: find-apk
      run: |
        cd android-project
        APK_PATH=$(find . -name "*.apk" -type f | head -1)
        echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Found APK: $APK_PATH"
        
        # Get APK size
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        echo "APK_SIZE=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "ðŸ“Š APK Size: $APK_SIZE"
        
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        path: ${{ steps.find-apk.outputs.APK_PATH }}
        retention-days: 7
        
    - name: Notify Success
      if: success()
      run: |
        python scripts/notify-webhook.py success
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        ARTIFACT_NAME: apk-${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        
    - name: Notify Failure
      if: failure()
      run: |
        python scripts/notify-webhook.py failure
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
