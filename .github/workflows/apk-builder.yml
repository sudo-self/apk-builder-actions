name: APK Builder

on:
  repository_dispatch:
    types: [apk_build]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Clone template
      run: |
        git clone https://github.com/sudo-self/template_apk.git android-project

    - name: Customize Android project
      run: |
        cd android-project
        python3 ../scripts/customize-project.py
      env:
        BUILD_ID: ${{ github.event.client_payload.buildId }}
        HOST_NAME: ${{ github.event.client_payload.hostName }}
        LAUNCH_URL: ${{ github.event.client_payload.launchUrl }}
        APP_NAME: ${{ github.event.client_payload.name }}
        LAUNCHER_NAME: ${{ github.event.client_payload.launcherName }}
        THEME_COLOR: ${{ github.event.client_payload.themeColor }}
        THEME_COLOR_DARK: ${{ github.event.client_payload.themeColorDark }}
        BACKGROUND_COLOR: ${{ github.event.client_payload.backgroundColor }}

    - name: Update app icon
      run: |
        cd android-project
        python3 ../scripts/update-app-icon.py
      env:
        ICON_CHOICE: ${{ github.event.client_payload.iconChoice }}

    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Sign APK
      run: |
        cd android-project
        python3 ../scripts/sign-apk.py

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.client_payload.name }}-app
        path: android-project/app/build/outputs/apk/debug/app-signed.apk




