name: APK Builder

on:
  repository_dispatch:
    types: [apk_build]
  workflow_dispatch:
    inputs:
      buildId:
        description: 'Build ID'
        required: true
        default: 'test-build-123'
      hostName:
        description: 'Host name'
        required: true
        default: 'example.com'
      name:
        description: 'App name'
        required: true
        default: 'Test App'
      launcherName:
        description: 'Launcher name'
        required: false
        default: 'Test App'
      themeColor:
        description: 'Theme color'
        required: false
        default: '#171717'
      themeColorDark:
        description: 'Theme color dark'
        required: false
        default: '#000000'
      backgroundColor:
        description: 'Background color'
        required: false
        default: '#FFFFFF'

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout APK Builder repo
      uses: actions/checkout@v4
      
    - name: Checkout Template APK repo
      uses: actions/checkout@v4
      with:
        repository: sudo-self/template_apk
        token: ${{ secrets.GITHUB_TOKEN }}
        path: android-project
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Debug - Show received inputs
      run: |
        echo "=== Repository Dispatch Payload ==="
        echo "Build ID: ${{ github.event.client_payload.buildId }}"
        echo "Host Name: ${{ github.event.client_payload.hostName }}"
        echo "Launch URL: ${{ github.event.client_payload.launchUrl }}"
        echo "App Name: ${{ github.event.client_payload.name }}"
        echo "Launcher Name: ${{ github.event.client_payload.launcherName }}"
        echo "Theme Color: ${{ github.event.client_payload.themeColor }}"
        echo "Theme Color Dark: ${{ github.event.client_payload.themeColorDark }}"
        echo "Background Color: ${{ github.event.client_payload.backgroundColor }}"
        echo ""
        echo "=== Manual Workflow Inputs ==="
        echo "Build ID: ${{ github.event.inputs.buildId }}"
        echo "Host Name: ${{ github.event.inputs.hostName }}"
        echo "App Name: ${{ github.event.inputs.name }}"
        echo "Launcher Name: ${{ github.event.inputs.launcherName }}"
        echo "Theme Color: ${{ github.event.inputs.themeColor }}"
        echo "Theme Color Dark: ${{ github.event.inputs.themeColorDark }}"
        echo "Background Color: ${{ github.event.inputs.backgroundColor }}"
      
    - name: Customize Android Project
      env:
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        HOST_NAME: ${{ github.event.client_payload.hostName || github.event.inputs.hostName }}
        LAUNCH_URL: ${{ github.event.client_payload.launchUrl || github.event.inputs.launchUrl || '/' }}
        APP_NAME: ${{ github.event.client_payload.name || github.event.inputs.name }}
        LAUNCHER_NAME: ${{ github.event.client_payload.launcherName || github.event.inputs.launcherName }}
        THEME_COLOR: ${{ github.event.client_payload.themeColor || github.event.inputs.themeColor || '#171717' }}
        THEME_COLOR_DARK: ${{ github.event.client_payload.themeColorDark || github.event.inputs.themeColorDark || '#000000' }}
        BACKGROUND_COLOR: ${{ github.event.client_payload.backgroundColor || github.event.inputs.backgroundColor || '#FFFFFF' }}
      run: |
        echo "Customizing Android project with:"
        echo "  BUILD_ID: $BUILD_ID"
        echo "  HOST_NAME: $HOST_NAME"
        echo "  LAUNCH_URL: $LAUNCH_URL"
        echo "  APP_NAME: $APP_NAME"
        echo "  LAUNCHER_NAME: $LAUNCHER_NAME"
        echo "  THEME_COLOR: $THEME_COLOR"
        echo "  THEME_COLOR_DARK: $THEME_COLOR_DARK"
        echo "  BACKGROUND_COLOR: $BACKGROUND_COLOR"
        python scripts/customize-project.py
      
    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleRelease --no-daemon --stacktrace
        
    - name: Find Built APK
      id: find-apk
      run: |
        cd android-project
        
        # Use direct path to the APK
        APK_PATH="app/build/outputs/apk/release/app-release-unsigned.apk"
        
        if [ ! -f "$APK_PATH" ]; then
          echo "APK not found at expected path: $APK_PATH"
          echo "Searching for APK files..."
          find . -name "*.apk" -type f
          exit 1
        fi
        
        echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
        echo "Found APK: $APK_PATH"
        
        # Get file size
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        echo "APK_SIZE=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "APK Size: $APK_SIZE"
        
    - name: Sign APK with android.keystore
      id: sign-apk
      run: |
        cd android-project
        
        # Verify keystore exists
        if [ ! -f "android.keystore" ]; then
          echo "android.keystore not found in project root"
          ls -la
          exit 1
        fi
        
        echo "Found android.keystore, signing APK..."
        
        # Set up Android SDK paths
        export ANDROID_HOME="${{ env.ANDROID_HOME }}"
        export ANDROID_SDK_ROOT="${{ env.ANDROID_SDK_ROOT }}"
        
        # Find apksigner
        APKSIGNER_PATH=$(find "$ANDROID_HOME/build-tools" -name "apksigner" | head -1)
        if [ -z "$APKSIGNER_PATH" ]; then
          echo "apksigner not found in Android SDK"
          exit 1
        fi
        
        echo "Using apksigner: $APKSIGNER_PATH"
        
        # Sign the APK
        UNSIGNED_APK="${{ steps.find-apk.outputs.APK_PATH }}"
        SIGNED_APK="${UNSIGNED_APK%.apk}-signed.apk"
        
        echo "Signing: $UNSIGNED_APK"
        echo "Output: $SIGNED_APK"
        
        # Sign with apksigner - ignore warnings
        "$APKSIGNER_PATH" sign \
          --ks android.keystore \
          --ks-pass pass:123321 \
          --key-pass pass:123321 \
          --ks-key-alias android \
          --out "$SIGNED_APK" \
          "$UNSIGNED_APK" || echo "Signing completed with warnings"
        
        echo "SIGNED_APK_PATH=$SIGNED_APK" >> $GITHUB_OUTPUT
        echo "APK signed successfully"
        
    - name: Verify Signed APK Exists
      id: verify-apk
      run: |
        cd android-project
        
        SIGNED_APK="${{ steps.sign-apk.outputs.SIGNED_APK_PATH }}"
        echo "Checking signed APK: $SIGNED_APK"
        
        if [ ! -f "$SIGNED_APK" ]; then
          echo "Signed APK not found at: $SIGNED_APK"
          echo "Available files in directory:"
          ls -la "$(dirname "$SIGNED_APK")" 2>/dev/null || echo "Directory not found"
          echo "All APK files:"
          find . -name "*.apk" -type f -exec ls -la {} \;
          exit 1
        fi
        
        SIGNED_SIZE=$(du -h "$SIGNED_APK" | cut -f1)
        echo "SIGNED_SIZE=$SIGNED_SIZE" >> $GITHUB_OUTPUT
        echo "Signed APK Size: $SIGNED_SIZE"
        echo "Signed APK verified"
        
    - name: Upload Signed APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        path: android-project/${{ steps.sign-apk.outputs.SIGNED_APK_PATH }}
        retention-days: 7
        
    - name: Create Build Summary
      run: |
        echo "APK Build Completed Successfully!"
        echo "### APK Build Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- App: ${{ github.event.client_payload.name || github.event.inputs.name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Domain: ${{ github.event.client_payload.hostName || github.event.inputs.hostName }}" >> $GITHUB_STEP_SUMMARY
        echo "- APK File: ${{ steps.sign-apk.outputs.SIGNED_APK_PATH }}" >> $GITHUB_STEP_SUMMARY
        echo "- Size: ${{ steps.find-apk.outputs.APK_SIZE }} (unsigned) -> ${{ steps.verify-apk.outputs.SIGNED_SIZE }} (signed)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Download:**" >> $GITHUB_STEP_SUMMARY
        echo "The signed APK is available in the artifacts below." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "> Note: The signature warnings are normal and don't affect APK functionality." >> $GITHUB_STEP_SUMMARY
        
    - name: Notify Success via Webhook
      if: success() && env.WEBHOOK_URL
      run: |
        python scripts/notify-webhook.py success
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        ARTIFACT_NAME: apk-${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        
    - name: Notify Failure via Webhook
      if: failure() && env.WEBHOOK_URL
      run: |
        python scripts/notify-webhook.py failure
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
