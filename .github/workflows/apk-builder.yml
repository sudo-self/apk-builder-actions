name: APK Builder

on:
  repository_dispatch:
    types: [apk_build]
  workflow_dispatch:
    inputs:
      buildId:
        description: 'Build ID'
        required: true
        default: 'test-build-123'
      hostName:
        description: 'Host name'
        required: true
        default: 'example.com'
      name:
        description: 'App name'
        required: true
        default: 'Test App'
      launcherName:
        description: 'Launcher name'
        required: false
        default: 'Test App'
      themeColor:
        description: 'Theme color'
        required: false
        default: '#FFFFFF'
      backgroundColor:
        description: 'Background color'
        required: false
        default: '#FFFFFF'

jobs:
  build-apk:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout APK Builder repo
      uses: actions/checkout@v4
      
    - name: Checkout Template APK repo
      uses: actions/checkout@v4
      with:
        repository: sudo-self/template_apk
        token: ${{ secrets.GITHUB_TOKEN }}
        path: android-project
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Customize Android Project
      run: |
        python scripts/customize-project.py
      
    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleRelease --no-daemon --stacktrace
        
    - name: Find Built APK
      id: find-apk
      run: |
        cd android-project
        # Look for the APK file - use absolute path
        APK_PATH=$(find "$(pwd)" -name "*.apk" -type f | grep -v signed | head -1)
        if [ -z "$APK_PATH" ]; then
          echo "‚ùå No APK file found"
          echo "Available APK files:"
          find . -name "*.apk" -type f
          exit 1
        fi
        
        #
        RELATIVE_APK_PATH=$(realpath --relative-to="$(pwd)/.." "$APK_PATH")
        echo "APK_PATH=$RELATIVE_APK_PATH" >> $GITHUB_OUTPUT
        echo "üì¶ Found APK: $RELATIVE_APK_PATH"
        
        #
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        echo "APK_SIZE=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "üìä APK Size: $APK_SIZE"
        
    - name: Sign APK with android.keystore
      id: sign-apk
      run: |
        cd android-project
        
        # Verify keystore exists
        if [ ! -f "android.keystore" ]; then
          echo "‚ùå android.keystore not found in project root"
          echo "Available files in project root:"
          ls -la
          exit 1
        fi
        
        echo "üîê Found android.keystore, signing APK..."
        
        # Set up Android SDK paths
        export ANDROID_HOME=${{ env.ANDROID_HOME }}
        export ANDROID_SDK_ROOT=${{ env.ANDROID_SDK_ROOT }}
        
        # Find apksigner
        APKSIGNER_PATH=$(find $ANDROID_HOME/build-tools -name "apksigner" | head -1)
        if [ -z "$APKSIGNER_PATH" ]; then
          echo "‚ùå apksigner not found in Android SDK"
          exit 1
        fi
        
        echo "üìÑ Using apksigner: $APKSIGNER_PATH"
        
        # Sign the APK
        UNSIGNED_APK="${{ steps.find-apk.outputs.APK_PATH }}"
        SIGNED_APK="${UNSIGNED_APK%.apk}-signed.apk"
        
        echo "üîè Signing: $UNSIGNED_APK"
        echo "üíæ Output: $SIGNED_APK"
        
        # Sign with apksigner
        $APKSIGNER_PATH sign \
          --ks android.keystore \
          --ks-pass pass:123321 \
          --key-pass pass:123321 \
          --ks-key-alias android \
          --out "$SIGNED_APK" \
          "$UNSIGNED_APK"
        
        # Verify the signature
        $APKSIGNER_PATH verify --verbose "$SIGNED_APK"
        
        echo "SIGNED_APK_PATH=$SIGNED_APK" >> $GITHUB_OUTPUT
        echo "‚úÖ APK signed successfully"
        
    - name: Verify Signed APK
      run: |
        cd android-project
        echo "üîç Verifying signed APK..."
        
        if [ ! -f "${{ steps.sign-apk.outputs.SIGNED_APK_PATH }}" ]; then
          echo "‚ùå Signed APK not found"
          exit 1
        fi
        
        SIGNED_SIZE=$(du -h "${{ steps.sign-apk.outputs.SIGNED_APK_PATH }}" | cut -f1)
        echo "üìä Signed APK Size: $SIGNED_SIZE"
        
        # List all APK files for debugging
        echo "üìÅ All APK files:"
        find . -name "*.apk" -type f -exec ls -la {} \;
        
    - name: Upload Signed APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk-${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        path: android-project/${{ steps.sign-apk.outputs.SIGNED_APK_PATH }}
        retention-days: 7
        
    - name: Get Artifact Download Info
      id: artifact-info
      run: |
        echo "üéâ Build completed successfully!"
        echo "üì¶ APK: ${{ steps.sign-apk.outputs.SIGNED_APK_PATH }}"
        echo "üìä Original size: ${{ steps.find-apk.outputs.APK_SIZE }}"
        echo "üîê Signed and ready for download"
        
    - name: Notify Success via Webhook
      if: success() && env.WEBHOOK_URL
      run: |
        python scripts/notify-webhook.py success
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        ARTIFACT_NAME: apk-${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
        
    - name: Notify Failure via Webhook
      if: failure() && env.WEBHOOK_URL
      run: |
        python scripts/notify-webhook.py failure
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
