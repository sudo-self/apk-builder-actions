name: APK Builder

on:
  repository_dispatch:
    types: [apk_build]

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Clone template
      run: |
        git clone https://github.com/sudo-self/template_apk.git android-project

    - name: Debug - Show original files
      run: |
        cd android-project
        echo "=== ORIGINAL FILES ==="
        echo "strings.xml:"
        cat app/src/main/res/values/strings.xml || echo "Not found"
        echo ""
        echo "AndroidManifest.xml:"
        cat app/src/main/AndroidManifest.xml | head -20 || echo "Not found"
        echo ""
        echo "MainActivity.java key lines:"
        grep -n "example.com" app/src/main/java/com/example/webviewapp/MainActivity.java || echo "Not found"

    - name: Customize Android project
      run: |
        cd android-project
        python3 ../scripts/customize-project.py
      env:
        BUILD_ID: ${{ github.event.client_payload.buildId }}
        HOST_NAME: ${{ github.event.client_payload.hostName }}
        LAUNCH_URL: ${{ github.event.client_payload.launchUrl }}
        APP_NAME: ${{ github.event.client_payload.name }}
        LAUNCHER_NAME: ${{ github.event.client_payload.launcherName }}
        THEME_COLOR: ${{ github.event.client_payload.themeColor }}
        THEME_COLOR_DARK: ${{ github.event.client_payload.themeColorDark }}
        BACKGROUND_COLOR: ${{ github.event.client_payload.backgroundColor }}

    - name: Debug - Show modified files
      run: |
        cd android-project
        echo "=== MODIFIED FILES ==="
        echo "strings.xml:"
        cat app/src/main/res/values/strings.xml || echo "Not found"
        echo ""
        echo "AndroidManifest.xml:"
        cat app/src/main/AndroidManifest.xml | head -20 || echo "Not found"
        echo ""
        echo "MainActivity.java key lines:"
        grep -n "http" app/src/main/java/com/example/webviewapp/MainActivity.java || echo "Not found"

    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Upload APK for testing
      uses: actions/upload-artifact@v4
      with:
        name: test-app
        path: android-project/app/build/outputs/apk/debug/app-debug.apk




