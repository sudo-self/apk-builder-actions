name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      host_name:
        description: 'Website URL'
        required: true
        default: 'https://example.com'
      app_name:
        description: 'App Name'  
        required: true
        default: 'My Web App'
      launch_url:
        description: 'Launch URL Path'
        required: false
        default: '/'
      theme_color:
        description: 'Theme Color'
        required: false
        default: '#171717'

env:
  BUILD_ID: ${{ github.run_id }}-${{ github.run_attempt }}
  HOST_NAME: ${{ inputs.host_name }}
  APP_NAME: ${{ inputs.app_name }}
  LAUNCH_URL: ${{ inputs.launch_url }}
  THEME_COLOR: ${{ inputs.theme_color }}
  THEME_COLOR_DARK: '#000000'
  BACKGROUND_COLOR: '#FFFFFF'

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Clone APK Template
      run: |
        git clone https://github.com/sudo-self/template_apk android-project
        echo "✅ Template cloned successfully"

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Verify Keystore Exists
      run: |
        cd android-project
        if [ -f "android.keystore" ]; then
          echo "✅ Keystore found in template"
          ls -la android.keystore
        else
          echo "❌ Keystore not found in template"
          exit 1
        fi

    - name: Make gradlew executable
      run: |
        cd android-project
        chmod +x gradlew
        echo "✅ Made gradlew executable"

    - name: Customize Android Project
      run: |
        echo "Customizing Android project..."
        python3 scripts/customize-project.py
        echo "✅ Project customization completed"

    - name: Build Signed Release APK
      run: |
        cd android-project
        echo "Building signed release APK..."
        ./gradlew assembleRelease
        echo "✅ Signed APK build completed"

    - name: Find and Verify APK
      id: find-apk
      run: |
        echo "Searching for signed APK..."
        
        # Look for release APK (should be signed with the template keystore)
        APK_PATH=$(find android-project -name "*.apk" -path "*/release/*" | grep -v "unaligned" | head -1)
        
        if [ -z "$APK_PATH" ]; then
          echo "❌ No release APK found"
          echo "Available APK files:"
          find android-project -name "*.apk" | while read file; do
            echo "  - $file"
          done
          exit 1
        fi
        
        echo "✅ Found APK: $APK_PATH"
        
        # Verify APK is signed
        if command -v apksigner >/dev/null 2>&1; then
          echo "Verifying APK signature..."
          apksigner verify --verbose "$APK_PATH" && echo "✅ APK is properly signed" || echo "⚠️  APK signature verification failed"
        else
          echo "⚠️  apksigner not available, skipping signature verification"
        fi
        
        # Get file size
        FILE_SIZE=$(du -h "$APK_PATH" | cut -f1)
        echo "APK Size: $FILE_SIZE"
        
        echo "APK_PATH=$APK_PATH" >> $GITHUB_OUTPUT
        echo "APK_FILENAME=$(basename $APK_PATH)" >> $GITHUB_OUTPUT

    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-app-${{ env.BUILD_ID }}
        path: ${{ steps.find-apk.outputs.APK_PATH }}
        retention-days: 30

    - name: Upload to S3
      id: upload-s3
      run: |
        echo "Uploading APK to S3..."
        python3 scripts/upload-apk.py ${{ env.BUILD_ID }}
        echo "✅ Upload completed"

    - name: Notify Success
      if: success()
      run: |
        echo "✅ Build completed successfully!"
        echo "APK: ${{ steps.find-apk.outputs.APK_PATH }}"
        echo "Download URL: ${{ steps.upload-s3.outputs.apk_url }}"
        python3 scripts/notify-webhook.py success

    - name: Notify Failure
      if: failure()
      run: |
        echo "❌ Build failed!"
        python3 scripts/notify-webhook.py failure




