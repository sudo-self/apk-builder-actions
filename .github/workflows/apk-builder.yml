name: APK Builder

on:
  repository_dispatch:
    types: [apk_build]
  workflow_dispatch:
    inputs:
      buildId:
        description: 'Build ID'
        required: true
      hostName:
        description: 'Host Name'
        required: true
      launchUrl:
        description: 'Launch URL'
        required: true
      name:
        description: 'App Name'
        required: true
      launcherName:
        description: 'Launcher Name'
        required: true
      themeColor:
        description: 'Theme Color'
        required: true
        default: '#171717'
      themeColorDark:
        description: 'Theme Color Dark'
        required: true
        default: '#000000'
      backgroundColor:
        description: 'Background Color'
        required: true
        default: '#FFFFFF'
      iconChoice:
        description: 'Icon Choice'
        required: false
        default: 'default'

env:
  BUILD_ID: ${{ github.event.client_payload.buildId || github.event.inputs.buildId }}
  HOST_NAME: ${{ github.event.client_payload.hostName || github.event.inputs.hostName }}
  LAUNCH_URL: ${{ github.event.client_payload.launchUrl || github.event.inputs.launchUrl }}
  APP_NAME: ${{ github.event.client_payload.name || github.event.inputs.name }}
  LAUNCHER_NAME: ${{ github.event.client_payload.launcherName || github.event.inputs.launcherName }}
  THEME_COLOR: ${{ github.event.client_payload.themeColor || github.event.inputs.themeColor }}
  THEME_COLOR_DARK: ${{ github.event.client_payload.themeColorDark || github.event.inputs.themeColorDark }}
  BACKGROUND_COLOR: ${{ github.event.client_payload.backgroundColor || github.event.inputs.backgroundColor }}
  ICON_CHOICE: ${{ github.event.client_payload.iconChoice || github.event.inputs.iconChoice }}

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Clone template project
      run: |
        git clone https://github.com/sudo-self/template_apk.git android-project
        cd android-project

    - name: Copy workflow scripts to template
      run: |
        cp -r scripts/* android-project/scripts/
        cp ../.github/workflows/apk-builder.yml android-project/ 2>/dev/null || true

    - name: Customize Android project
      run: |
        cd android-project
        python3 scripts/customize-project.py
      env:
        BUILD_ID: ${{ env.BUILD_ID }}
        HOST_NAME: ${{ env.HOST_NAME }}
        LAUNCH_URL: ${{ env.LAUNCH_URL }}
        APP_NAME: ${{ env.APP_NAME }}
        LAUNCHER_NAME: ${{ env.LAUNCHER_NAME }}
        THEME_COLOR: ${{ env.THEME_COLOR }}
        THEME_COLOR_DARK: ${{ env.THEME_COLOR_DARK }}
        BACKGROUND_COLOR: ${{ env.BACKGROUND_COLOR }}

    - name: Update app icon
      run: |
        cd android-project
        python3 scripts/update-app-icon.py
      env:
        ICON_CHOICE: ${{ env.ICON_CHOICE }}

    - name: Build APK
      run: |
        cd android-project
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Sign and align APK
      run: |
        cd android-project
        python3 scripts/sign-apk.py

    - name: Find built APK
      id: find-apk
      run: |
        cd android-project
        python3 scripts/find-apk.py

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-${{ env.BUILD_ID }}
        path: android-project/${{ steps.find-apk.outputs.apk_path }}
        retention-days: 7

    - name: Notify webhook success
      if: success()
      run: python3 scripts/notify-webhook.py success
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ env.BUILD_ID }}
        ARTIFACT_NAME: ${{ env.APP_NAME }}-${{ env.BUILD_ID }}

    - name: Notify webhook failure
      if: failure()
      run: python3 scripts/notify-webhook.py failure
      env:
        WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
        BUILD_ID: ${{ env.BUILD_ID }}




